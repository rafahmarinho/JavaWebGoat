trigger:
- main

pool:
  vmImage: ubuntu-latest

steps:
- task: GoTool@0
  inputs:
    version: '1.19'
  displayName: 'Install Go'

- script: |
    # Criar diretório de trabalho
    mkdir -p /tmp/dsmcli
    cd /tmp/dsmcli
    
    # Clonar o repositório
    git clone https://github.com/senhasegura/dsmcli.git .
    
    # Compilar o projeto
    go build -o dsm
    
    # Criar diretório bin se não existir
    sudo mkdir -p /usr/local/bin
    
    # Mover o executável e dar permissões
    sudo cp dsm /usr/local/bin/
    sudo chmod +x /usr/local/bin/dsm
    
    # Limpar arquivos temporários
    cd ..
    rm -rf /tmp/dsmcli
  displayName: 'Install DSM CLI'

- script: |
    # Verificar a instalação
    dsm version
  displayName: 'Verify DSM CLI Installation'

- script: |
    # Criar arquivo de configuração
    cat > .config.yml << EOF
    auth:
      url: $(DSM_URL)
      client-id: $(DSM_CLIENT_ID)
      client-secret: $(DSM_CLIENT_SECRET)
    EOF
  displayName: 'Create DSM Configuration'

- script: |
    dsm runb \
      --app-name $(APPLICATION) \
      --system $(SYSTEM) \
      --environment $(ENVIRONMENT) \
      --config .config.yml \
      --tool-name azure-devops
    rm -f .runb.vars
  displayName: 'DSM CLI Running Belt execution'
  env:
    APPLICATION: $(APPLICATION)
    SYSTEM: $(SYSTEM)
    ENVIRONMENT: $(ENVIRONMENT)
    DSM_URL: $(DSM_URL)
    DSM_CLIENT_ID: $(DSM_CLIENT_ID)
    DSM_CLIENT_SECRET: $(DSM_CLIENT_SECRET)